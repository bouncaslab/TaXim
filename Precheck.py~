# -*- coding: utf-8 -*-
import os
import re

def remover(pattern, string):
    scanner = re.search(pattern, string, re.IGNORECASE)
    return (string[:scanner.start()] + string[scanner.end():]).strip()

from datetime import datetime
path = os.path.dirname(os.path.abspath(__file__))
topList = ["4C_4L1_4L2_1L3"]
current = path + "/Results/" + datetime.now().strftime('%Y-%m-%d_%H:%M:%S')
os.makedirs(current)
log = " 2>&1 | tee -a " + current + "/ExperimentLogs.txt"
m2sArgs = ""
for line in open(path + "/Paths"):
    if line.strip()[:3].lower() == "m2s":
        m2s = remover("m2s *= *", line)
for experiment in open(path + "/Experiments"):
    exResults = current + "/" + experiment.strip()
    if not os.path.exists(path + "/Benchmarks/"
        + experiment.strip() + "/runspec"):
        continue
    os.mkdir(exResults)
    for topology in topList:
        tail = ""
        for line in open(path + "/Benchmarks/"
        + experiment.strip() + "/runspec"):
            if line.strip()[:3].lower() == "exe":
                exe = (path + "/Benchmarks/" + experiment.strip() 
                + "/" + remover("exe *= *", line))
            if line.strip()[:4].lower() == "args":
                args = remover("args *= *", line).split()
                for arg in args:
                    if arg == "$NTHREADS":
                        tail += " " + topology[0]
                    elif "." in arg:
                        tail += (" " + path + "/Benchmarks/" 
                        + experiment.strip() + "/" + arg)
                    else:
                        tail += " " + arg
        if line.strip()[:3].lower() == "m2s":
            m2sArgs = remover("m2s *= *", line)
        os.mkdir(exResults + "/" + topology)
        topologyPath = path + "/Topologies/" + topology
        topologyResult = exResults + "/" + topology
        os.system(m2s + " --x86-sim functional " 
        + exe + tail + log)
    print ("Experiments completed, check the output files under "
    + "benchmark folders to confirm current settings!")
